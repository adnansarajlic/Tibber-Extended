# Tibber Extended f√∂r Home Assistant

<p align="center">
  <img src="https://github.com/adnansarajlic/tibber-extended/raw/main/logo.png" alt="Tibber Extended Logo" width="200"/>
</p>

En kraftfull custom integration som h√§mtar elpriser och prisniv√•er fr√•n Tibber's API med avancerade funktioner.

## ‚ú® Funktioner

- üîÑ Automatisk h√§mtning av dagens och morgondagens elpriser
- üìä Prisniv√•er (VERY_CHEAP, CHEAP, NORMAL, EXPENSIVE, VERY_EXPENSIVE) direkt fr√•n Tibber
- ‚è∞ Flera konfigurerbara uppdateringstider (t.ex. kl 13:00 och 15:00)
- üïê St√∂d f√∂r QUARTER_HOURLY (15 min) eller HOURLY (60 min) uppl√∂sning
- üè† Anpassningsbara hemnamn f√∂r sensornamn
- üí± V√§lj valuta (SEK, NOK, EUR, DKK)
- üÜì Demo-token inkluderad f√∂r testning
- üåç Svenskt och engelskt spr√•kst√∂d
- üìà Detaljerad prisdata: total, energi, skatt
- ‚ö° Automatisk uppdatering varje kvart/timme
- üîß √Ñndra inst√§llningar utan att ta bort integration
- üìà Automatisk ber√§kning av min/max/medelpris

## üì¶ Installation via HACS

### Metod 1: HACS (Rekommenderat)

1. √ñppna HACS i Home Assistant
2. Klicka p√• **"Integrations"**
3. Klicka p√• de tre prickarna l√§ngst upp till h√∂ger
4. V√§lj **"Custom repositories"**
5. L√§gg till URL: `https://github.com/adnansarajlic/tibber-extended`
6. V√§lj kategori: **"Integration"**
7. Klicka **"ADD"**
8. S√∂k efter **"Tibber Extended"** och installera
9. Starta om Home Assistant

### Metod 2: Manuell Installation

1. Ladda ner senaste release fr√•n GitHub
2. Kopiera mappen `custom_components/tibber_extended` till din Home Assistant `config/custom_components` mapp
3. Starta om Home Assistant

## ‚öôÔ∏è Konfiguration

### 1. H√§mta din Tibber API Token (Valfritt)

**OBS:** Du kan anv√§nda den inkluderade demo-token f√∂r testning, men den kan sluta fungera utan f√∂rvarning!

F√∂r personlig anv√§ndning med r√§tt elomr√•de, h√§mta din egen token:

1. G√• till [Tibber Developer Portal](https://developer.tibber.com/settings/access-token)
2. Logga in med ditt Tibber-konto
3. Skapa en ny token om den inte redan finns under "Access Token"
4. Kopiera token

### 2. L√§gg till Integration

1. G√• till **Inst√§llningar** ‚Üí **Enheter och tj√§nster**
2. Klicka p√• **+ L√ÑGG TILL INTEGRATION**
3. S√∂k efter **"Tibber Extended"**
4. Konfigurera:
   - **API Token**: L√§mna tomt f√∂r demo-token, eller ange din egen
   - **Hemnamn**: T.ex. "Mitt Hem" (anv√§nds i sensornamn)
   - **Prisuppl√∂sning**: QUARTER_HOURLY (15 min) eller HOURLY (60 min)
   - **Valuta**: SEK, NOK, EUR eller DKK
   - **Uppdateringstider**: T.ex. "13:00, 15:00" (kommaseparerade)

**Standardv√§rden:**
- Demo-token anv√§nds om inget anges
- Hemnamn: "Mitt Hem"
- Uppl√∂sning: QUARTER_HOURLY
- Valuta: SEK
- Uppdateringstider: 13:00 och 15:00

### Varf√∂r flera uppdateringstider?

Tibber publicerar:
- **13:00-14:00**: Morgondagens priser sl√§pps oftast h√§r
- **15:00**: Extra kontroll om priser missades
- **20:00** (valfritt): F√∂r att s√§kerst√§lla senaste data

## üìä Sensor

Integrationen skapar EN sensor per hem:

### `sensor.[hemnamn]_electricity_price`

**State:** Aktuellt totalpris (kr/kWh eller vald valuta)

**Uppdateras automatiskt:**
- QUARTER_HOURLY: Varje 15:e minut
- HOURLY: Varje timme

**Attribut:**
```json
{
  "current_total": 0.0956,
  "current_energy": 0.0650,
  "current_tax": 0.0306,
  "current_level": "VERY_CHEAP",
  "current_starts_at": "2025-10-06T04:00:00.000+02:00",
  "currency": "SEK",
  "resolution": "QUARTER_HOURLY",
  
  "today": {
    "count": 96,
    "prices": [
      {
        "total": 0.0956,
        "energy": 0.0650,
        "tax": 0.0306,
        "startsAt": "2025-10-06T00:00:00.000+02:00",
        "level": "VERY_CHEAP"
      },
      ...
    ],
    "total": {
      "min": 0.0848,
      "max": 0.6634,
      "avg": 0.1234
    },
    "energy": {
      "min": 0.0548,
      "max": 0.6334,
      "avg": 0.0934
    }
  },
  
  "tomorrow": {
    "count": 96,
    "prices": [...],
    "total": {...},
    "energy": {...}
  }
}
```

## ü§ñ Automatiseringsexempel

### Starta tv√§ttmaskin vid billigt pris

```yaml
alias: "Notifikation: Billigt elpris"
description: ""
triggers:
  - trigger: state
    entity_id:
      - sensor.mitt_hem_electricity_price
    attribute: current_level
    to: VERY_CHEAP
conditions:
  - condition: time
    after: "06:00:00"
    before: "22:00:00"
actions:
  - action: notify.mobile_app_iphone
    metadata: {}
    data:
      title: ‚ö° Mycket billigt elpris!
      message: >
        Nu √§r elpriset {{ states('sensor.mitt_hem_electricity_price') }}
        kr/kWh.  Perfekt tid att starta tv√§ttmaskin eller diskmaskin!
```

### Hitta billigaste 3-timmarsperioden idag

```yaml
template:
  - sensor:
      - name: "Billigaste 3-timmarsperioden"
        state: >
          {% set today_data = state_attr('sensor.mitt_hem_electricity_price', 'today') %}
          {% if today_data and today_data.prices and today_data.prices | length > 12 %}
            {% set prices = today_data.prices %}
            {% set ns = namespace(best_start=none, best_sum=999) %}
            {% for i in range(0, (prices | length) - 12) %}
              {% set window_sum = prices[i:i+12] | map(attribute='total') | sum %}
              {% if window_sum < ns.best_sum %}
                {% set ns.best_start = i %}
                {% set ns.best_sum = window_sum %}
              {% endif %}
            {% endfor %}
            {% if ns.best_start is not none %}
              {{ (as_timestamp(prices[ns.best_start].startsAt) | timestamp_custom('%H:%M')) }}
            {% endif %}
          {% else %}
            Ej tillg√§ngligt
          {% endif %}
        attributes:
          avg_price: >
            {% set today_data = state_attr('sensor.mitt_hem_electricity_price', 'today') %}
            {% if today_data and today_data.prices and today_data.prices | length > 12 %}
              {% set prices = today_data.prices %}
              {% set ns = namespace(best_start=none, best_sum=999) %}
              {% for i in range(0, (prices | length) - 12) %}
                {% set window_sum = prices[i:i+12] | map(attribute='total') | sum %}
                {% if window_sum < ns.best_sum %}
                  {% set ns.best_start = i %}
                  {% set ns.best_sum = window_sum %}
                {% endif %}
              {% endfor %}
              {{ (ns.best_sum / 12) | round(4) }}
            {% endif %}
          end_time: >
            {% set today_data = state_attr('sensor.mitt_hem_electricity_price', 'today') %}
            {% if today_data and today_data.prices and today_data.prices | length > 12 %}
              {% set prices = today_data.prices %}
              {% set ns = namespace(best_start=none, best_sum=999) %}
              {% for i in range(0, (prices | length) - 12) %}
                {% set window_sum = prices[i:i+12] | map(attribute='total') | sum %}
                {% if window_sum < ns.best_sum %}
                  {% set ns.best_start = i %}
                  {% set ns.best_sum = window_sum %}
                {% endif %}
              {% endfor %}
              {% if ns.best_start is not none %}
                {{ (as_timestamp(prices[ns.best_start + 11].startsAt) | timestamp_custom('%H:%M')) }}
              {% endif %}
            {% endif %}
          period_description: >
            {% set today_data = state_attr('sensor.mitt_hem_electricity_price', 'today') %}
            {% if today_data and today_data.prices and today_data.prices | length > 12 %}
              {% set prices = today_data.prices %}
              {% set ns = namespace(best_start=none, best_sum=999) %}
              {% for i in range(0, (prices | length) - 12) %>
                {% set window_sum = prices[i:i+12] | map(attribute='total') | sum %}
                {% if window_sum < ns.best_sum %}
                  {% set ns.best_start = i %}
                  {% set ns.best_sum = window_sum %}
                {% endif %}
              {% endfor %}
              {% if ns.best_start is not none %}
                {{ (as_timestamp(prices[ns.best_start].startsAt) | timestamp_custom('%H:%M')) }} - {{ (as_timestamp(prices[ns.best_start + 11].startsAt) | timestamp_custom('%H:%M')) }}
              {% endif %}
            {% endif %}

```

### V√§rmepump - K√∂r under billiga timmar

```yaml
automation:
  - alias: "V√§rmepump - Boost under billiga timmar"
    trigger:
      - platform: time_pattern
        minutes: "/15"
    condition:
      - condition: numeric_state
        entity_id: sensor.mitt_hem_electricity_price
        below: 0.09  # Under 9 √∂re/kWh
    action:
      - service: climate.set_temperature
        target:
          entity_id: climate.varmepump
        data:
          temperature: 24

  - alias: "V√§rmepump - Normal under dyra timmar"
    trigger:
      - platform: time_pattern
        minutes: "/15"
    condition:
      - condition: numeric_state
        entity_id: sensor.mitt_hem_electricity_price
        above: 0.15  # √ñver 15 √∂re/kWh
    action:
      - service: climate.set_temperature
        target:
          entity_id: climate.varmepump
        data:
          temperature: 20
```

### Visa priser i Apexcharts kort

![Apexcharts Card exempel](image.png)

```yaml
type: custom:apexcharts-card
apex_config:
  legend:
    show: false
experimental:
  color_threshold: true
graph_span: 48h
header:
  title: Elpris idag/imorgon (Tibber)
  show: true
  show_states: true
span:
  start: day
now:
  show: true
  label: Just nu
show:
  last_updated: true
series:
  - entity: sensor.myrvagen_electricity_price
    color_threshold:
      - value: 1.5
        color: "#B13A33"
      - value: 1
        color: "#1982C4FF"
      - value: 0
        color: "#03c03c"
    name: Idag
    type: column
    show:
      extremas: time
      in_header: false
      legend_value: false
    color: "#03c03c"
    float_precision: 2
    data_generator: |
      return entity.attributes.today.prices.map((entry, index) => {
        return [new Date(entry["startsAt"]).getTime(), entry["total"]];
      });
  - entity: sensor.myrvagen_electricity_price
    color_threshold:
      - value: 1.5
        color: "#B13A33"
      - value: 1
        color: "#1982C4FF"
      - value: 0
        color: "#03c03c"
    name: Imorgon
    type: column
    show:
      extremas: time
      in_header: false
      legend_value: false
    color: "#03c03c"
    float_precision: 2
    data_generator: |
      return entity.attributes.tomorrow.prices.map((entry, index) => {
        return [new Date(entry["startsAt"]).getTime(), entry["total"]];
      });
  - entity: sensor.myrvagen_electricity_price
    name: Just nu
    type: column
    show:
      in_chart: false
    float_precision: 2
```

## ü§ù Bidra

Bidrag √§r v√§lkomna! 

- üêõ Rapportera buggar via [GitHub Issues](https://github.com/adnansarajlic/tibber-extended/issues)
- üí° F√∂resl√• nya funktioner
- üîß Skicka Pull Requests

## üìÑ Licens

MIT License - Se [LICENSE](LICENSE) f√∂r detaljer

## üôè Tack till

- [Tibber](https://tibber.com/) f√∂r deras fantastiska API
- Home Assistant-communityn f√∂r inspiration och hj√§lp

## üìû Support

- **GitHub Issues**: [github.com/adnansarajlic/tibber-extended/issues](https://github.com/adnansarajlic/tibber-extended/issues)
- **Home Assistant Community**: [community.home-assistant.io](https://community.home-assistant.io/)

---

**‚ö†Ô∏è Viktigt:** Denna integration √§r inte officiellt supporterad av Tibber. Demo-token tillhandah√•lls f√∂r testning men kan sluta fungera.


**üîí S√§kerhet:** Din API-token lagras s√§kert i Home Assistant's krypterade storage.
